# Work-life Balance AI Backend

RESTful API service built with Express and TypeScript for managing users, notes, schedules, questionnaires, work-life balance (WLB) calculate, and AI chat. The service uses PostgreSQL via Prisma ORM, JWT-based authentication, and scheduled cron jobs for periodic tasks.

## Tech Stack

- Node.js, Express, TypeScript
- Prisma ORM (PostgreSQL)
- Zod for request validation
- JWT for authentication
- Node-cron for scheduled jobs
- Google Gemini API for AI services

## Project Layout

- `src/index.ts` – Express bootstrap, middleware, and route mounting
- `src/routes/` – Feature modules: user, note, schedule, questionnaire, WLB, AI chat
- `src/middleware/` – Authentication, validation, error handling
- `src/jobs/` – Cron jobs for WLB recalculation and chat quota reset
- `src/utils/` – Shared utilities (JWT, bcrypt, http exeption,Prisma wrapper, response helper, constants)
- `prisma/schema.prisma` – Database schema and migration source

## Getting Started

1. **Prerequisites**: Node.js ≥ 18 and pnpm installed (`corepack enable` or `npm i -g pnpm`). Ensure PostgreSQL is available and reachable.
2. **Environment**: Copy `.env.example` to `.env` and fill values:
   - `NODE_ENV` (e.g., `development` or `production`)
   - `PORT` (default `4000` if unset)
   - `DATABASE_URL` (PostgreSQL connection string)
   - `GEMINI_API_KEY` (Google Gemini key for chat)
   - `JWT_ACCESS_SECRET`, `JWT_REFRESH_SECRET`, `JWT_ACCESS_EXPIRES_IN`, `JWT_REFRESH_EXPIRES_IN`
3. **Install dependencies**: `pnpm install`
4. **Database setup**: Apply migrations and generate Prisma client
   - Generate prisma client: `npx prisma generate`
   - Local/dev: `pnpm prisma migrate dev`
   - Production/CI: `pnpm prisma migrate deploy`
5. **Run locally**: `pnpm dev` (ts-node + nodemon)
6. **Build**: `pnpm build` (outputs to `dist/`)
7. **Run compiled**: `pnpm start` (uses `index.js` in `dist` output)

## API Documentation — Generated by Claude Sonnet 4.5 (Not Fully Accurate)

All endpoints require `Authorization: Bearer <accessToken>` header except for register, login, and refresh-token.

### User Endpoints (`/api/user`)

#### Register

- **POST** `/api/user/register`
- **Request Body**:
  ```json
  {
    "name": "John Doe",
    "email": "john.doe@example.com",
    "password": "password123",
    "confirmPassword": "password123",
    "phone": "081234567890",
    "gender": "male",
    "isStudent": true,
    "age": 22,
    "field": "Computer Science",
    "hobbies": "Reading, Gaming"
  }
  ```
- **Response** (201 Created):
  ```json
  {
    "status": "created",
    "data": {
      "id": 1,
      "name": "John Doe",
      "email": "john.doe@example.com",
      "phone": "081234567890",
      "gender": "male",
      "isStudent": true,
      "age": 22,
      "field": "Computer Science",
      "hobbies": "Reading, Gaming",
      "hasAnsweredQuestionnaire": false,
      "recalculateProgress": false,
      "chatQuota": 8,
      "feedback": null,
      "createdAt": "2026-01-01T10:00:00.000Z",
      "updatedAt": "2026-01-01T10:00:00.000Z"
    }
  }
  ```

#### Login

- **POST** `/api/user/login`
- **Request Body**:
  ```json
  {
    "email": "john.doe@example.com",
    "password": "password123"
  }
  ```
- **Response** (200 OK):
  ```json
  {
    "status": "success",
    "data": {
      "user": {
        "id": 1,
        "name": "John Doe",
        "email": "john.doe@example.com",
        "phone": "081234567890",
        "gender": "male",
        "isStudent": true,
        "age": 22,
        "field": "Computer Science",
        "hobbies": "Reading, Gaming",
        "hasAnsweredQuestionnaire": false,
        "recalculateProgress": false,
        "chatQuota": 8,
        "feedback": null,
        "createdAt": "2026-01-01T10:00:00.000Z",
        "updatedAt": "2026-01-01T10:00:00.000Z"
      },
      "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
      "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
    }
  }
  ```
- **Note**: `refreshToken` is also set as httpOnly cookie

#### Get All Users

- **GET** `/api/user`
- **Auth**: Required
- **Response** (200 OK):
  ```json
  {
    "status": "success",
    "data": [
      {
        "id": 1,
        "name": "John Doe",
        "email": "john.doe@example.com",
        "phone": "081234567890",
        "gender": "male",
        "isStudent": true,
        "age": 22,
        "field": "Computer Science",
        "hobbies": "Reading, Gaming",
        "hasAnsweredQuestionnaire": true,
        "recalculateProgress": false,
        "chatQuota": 5,
        "feedback": null,
        "createdAt": "2026-01-01T10:00:00.000Z",
        "updatedAt": "2026-01-01T10:00:00.000Z"
      }
    ]
  }
  ```

#### Get Profile

- **GET** `/api/user/profile`
- **Auth**: Required
- **Response** (200 OK):
  ```json
  {
    "status": "success",
    "data": {
      "id": 1,
      "name": "John Doe",
      "email": "john.doe@example.com",
      "phone": "081234567890",
      "gender": "male",
      "isStudent": true,
      "age": 22,
      "field": "Computer Science",
      "hobbies": "Reading, Gaming",
      "hasAnsweredQuestionnaire": true,
      "recalculateProgress": false,
      "chatQuota": 5,
      "feedback": null,
      "createdAt": "2026-01-01T10:00:00.000Z",
      "updatedAt": "2026-01-01T10:00:00.000Z"
    }
  }
  ```

#### Refresh Token

- **POST** `/api/user/refresh-token`
- **Cookies**: `refreshToken` (httpOnly)
- **Response** (200 OK):
  ```json
  {
    "status": "success",
    "data": {
      "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
      "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
    }
  }
  ```
- **Note**: New `refreshToken` is also set as httpOnly cookie

#### Logout

- **POST** `/api/user/logout`
- **Auth**: Required
- **Response** (200 OK):
  ```json
  {
    "status": "success",
    "data": {
      "message": "Logout successful"
    }
  }
  ```
- **Note**: Clears `refreshToken` cookie

#### Get Feedback

- **GET** `/api/user/feedback`
- **Auth**: Required
- **Response** (200 OK):
  ```json
  {
    "status": "success",
    "data": {
      "feedback": "The app has been very helpful in managing my work-life balance!"
    }
  }
  ```

#### Update Feedback

- **POST** `/api/user/feedback`
- **Auth**: Required
- **Request Body**:
  ```json
  {
    "feedback": "The app has been very helpful in managing my work-life balance!"
  }
  ```
- **Response** (200 OK):
  ```json
  {
    "status": "success",
    "data": {
      "id": 1,
      "name": "John Doe",
      "email": "john.doe@example.com",
      "feedback": "The app has been very helpful in managing my work-life balance!",
      "updatedAt": "2026-01-01T11:00:00.000Z"
    }
  }
  ```

---

### Note Endpoints (`/api/note`)

#### Get All Notes

- **GET** `/api/note`
- **Auth**: Required
- **Response** (200 OK):
  ```json
  [
    {
      "id": 1,
      "date": "2026-01-01T00:00:00.000Z",
      "userId": 1,
      "createdAt": "2026-01-01T10:00:00.000Z",
      "updatedAt": "2026-01-01T10:00:00.000Z",
      "items": [
        {
          "id": 1,
          "content": "Completed project presentation",
          "noteId": 1,
          "createdAt": "2026-01-01T10:00:00.000Z",
          "updatedAt": "2026-01-01T10:00:00.000Z"
        },
        {
          "id": 2,
          "content": "Had a productive meeting with team",
          "noteId": 1,
          "createdAt": "2026-01-01T10:05:00.000Z",
          "updatedAt": "2026-01-01T10:05:00.000Z"
        }
      ]
    }
  ]
  ```

#### Get User's Notes

- **GET** `/api/note/me`
- **Auth**: Required
- **Response** (200 OK):
  ```json
  [
    {
      "id": 1,
      "date": "2026-01-01T00:00:00.000Z",
      "userId": 1,
      "createdAt": "2026-01-01T10:00:00.000Z",
      "updatedAt": "2026-01-01T10:00:00.000Z",
      "items": [
        {
          "id": 1,
          "content": "Completed project presentation",
          "noteId": 1,
          "createdAt": "2026-01-01T10:00:00.000Z",
          "updatedAt": "2026-01-01T10:00:00.000Z"
        }
      ]
    }
  ]
  ```

#### Create Note

- **POST** `/api/note`
- **Auth**: Required
- **Request Body**:
  ```json
  {
    "content": "Completed important tasks today and felt productive"
  }
  ```
- **Response** (201 Created):
  ```json
  {
    "id": 1,
    "date": "2026-01-01T00:00:00.000Z",
    "userId": 1,
    "createdAt": "2026-01-01T10:00:00.000Z",
    "updatedAt": "2026-01-01T10:00:00.000Z",
    "items": [
      {
        "id": 1,
        "content": "Completed important tasks today and felt productive",
        "noteId": 1,
        "createdAt": "2026-01-01T10:00:00.000Z",
        "updatedAt": "2026-01-01T10:00:00.000Z"
      }
    ]
  }
  ```

---

### Schedule Endpoints (`/api/schedule`)

#### Get All Schedules

- **GET** `/api/schedule`
- **Auth**: Required
- **Response** (200 OK):
  ```json
  [
    {
      "id": 1,
      "date": "2026-01-01T00:00:00.000Z",
      "userId": 1,
      "createdAt": "2026-01-01T08:00:00.000Z",
      "updatedAt": "2026-01-01T08:00:00.000Z",
      "items": [
        {
          "id": 1,
          "desc": "Morning team meeting",
          "time": "2026-01-01T09:00:00.000Z",
          "looping": "WEEKDAYS",
          "category": "WORK_ACTIVITY",
          "scheduleId": 1,
          "createdAt": "2026-01-01T08:00:00.000Z",
          "updatedAt": "2026-01-01T08:00:00.000Z"
        },
        {
          "id": 2,
          "desc": "Gym workout",
          "time": "2026-01-01T18:00:00.000Z",
          "looping": "EVERYDAY",
          "category": "PERSONAL_TIME",
          "scheduleId": 1,
          "createdAt": "2026-01-01T08:00:00.000Z",
          "updatedAt": "2026-01-01T08:00:00.000Z"
        }
      ]
    }
  ]
  ```

#### Get Today's Schedules

- **GET** `/api/schedule/today`
- **Auth**: Required
- **Response** (200 OK):
  ```json
  [
    {
      "id": 1,
      "desc": "Morning team meeting",
      "time": "2026-01-01T09:00:00.000Z",
      "looping": "WEEKDAYS",
      "category": "WORK_ACTIVITY",
      "scheduleId": 1,
      "createdAt": "2026-01-01T08:00:00.000Z",
      "updatedAt": "2026-01-01T08:00:00.000Z"
    },
    {
      "id": 2,
      "desc": "Online course - Web Development",
      "time": "2026-01-01T14:00:00.000Z",
      "looping": null,
      "category": "SELF_DEVELOPMENT",
      "scheduleId": 1,
      "createdAt": "2026-01-01T08:00:00.000Z",
      "updatedAt": "2026-01-01T08:00:00.000Z"
    }
  ]
  ```

#### Get User's Schedules

- **GET** `/api/schedule/me`
- **Auth**: Required
- **Response** (200 OK):
  ```json
  [
    {
      "id": 1,
      "date": "2026-01-01T00:00:00.000Z",
      "userId": 1,
      "createdAt": "2026-01-01T08:00:00.000Z",
      "updatedAt": "2026-01-01T08:00:00.000Z",
      "items": [
        {
          "id": 1,
          "desc": "Morning team meeting",
          "time": "2026-01-01T09:00:00.000Z",
          "looping": "WEEKDAYS",
          "category": "WORK_ACTIVITY",
          "scheduleId": 1,
          "createdAt": "2026-01-01T08:00:00.000Z",
          "updatedAt": "2026-01-01T08:00:00.000Z"
        }
      ]
    }
  ]
  ```

#### Create Schedule

- **POST** `/api/schedule`
- **Auth**: Required
- **Request Body**:
  ```json
  {
    "desc": "Morning team meeting",
    "time": "2026-01-01T09:00:00.000Z",
    "looping": "WEEKDAYS",
    "category": "WORK_ACTIVITY"
  }
  ```
- **Response** (201 Created):
  ```json
  {
    "id": 1,
    "date": "2026-01-01T00:00:00.000Z",
    "userId": 1,
    "createdAt": "2026-01-01T08:00:00.000Z",
    "updatedAt": "2026-01-01T08:00:00.000Z",
    "items": [
      {
        "id": 1,
        "desc": "Morning team meeting",
        "time": "2026-01-01T09:00:00.000Z",
        "looping": "WEEKDAYS",
        "category": "WORK_ACTIVITY",
        "scheduleId": 1,
        "createdAt": "2026-01-01T08:00:00.000Z",
        "updatedAt": "2026-01-01T08:00:00.000Z"
      }
    ]
  }
  ```
- **Note**: `looping` can be `"EVERYDAY"`, `"WEEKDAYS"`, `"WEEKENDS"`, or `null`

---

### Questionnaire Endpoints (`/api/questionnaire`)

#### Get All Questionnaires

- **GET** `/api/questionnaire`
- **Auth**: Required
- **Response** (200 OK):
  ```json
  [
    {
      "id": 1,
      "userId": 1,
      "answer": ["SANGAT_SETUJU", "CUKUP_SETUJU", "NETRAL", "..."],
      "createdAt": "2026-01-01T10:00:00.000Z",
      "updatedAt": "2026-01-01T10:00:00.000Z"
    }
  ]
  ```

#### Get User's Questionnaire

- **GET** `/api/questionnaire/me`
- **Auth**: Required
- **Response** (200 OK):
  ```json
  {
    "id": 1,
    "userId": 1,
    "answer": ["SANGAT_SETUJU", "CUKUP_SETUJU", "NETRAL", "..."],
    "createdAt": "2026-01-01T10:00:00.000Z",
    "updatedAt": "2026-01-01T10:00:00.000Z"
  }
  ```

#### Create Questionnaire Answer

- **POST** `/api/questionnaire`
- **Auth**: Required
- **Request Body**:
  ```json
  {
    "answers": [
      "SANGAT_SETUJU",
      "CUKUP_SETUJU",
      "NETRAL",
      "KURANG_SETUJU",
      "SANGAT_SETUJU",
      "..."
    ]
  }
  ```
- **Response** (201 Created): Returns WLB analysis result (see WLB Analyze endpoint response)
- **Note**: Answer options are `SANGAT_SETUJU`, `CUKUP_SETUJU`, `NETRAL`, `KURANG_SETUJU`, `SANGAT_TIDAK_SETUJU`. Total 23 questions for students.

#### Delete Questionnaire Answer

- **DELETE** `/api/questionnaire`
- **Auth**: Required
- **Response** (200 OK):
  ```json
  {
    "id": 1,
    "userId": 1,
    "answer": [...],
    "createdAt": "2026-01-01T10:00:00.000Z",
    "updatedAt": "2026-01-01T10:00:00.000Z"
  }
  ```

---

### Work-Life Balance Endpoints (`/api/wlb`)

#### Get Today's WLB

- **GET** `/api/wlb/today`
- **Auth**: Required
- **Response** (200 OK):
  ```json
  {
    "id": 1,
    "date": "2026-01-01T10:00:00.000Z",
    "score": 75,
    "summary": "Your work-life balance is good overall. You're managing your time well between work and personal activities, but there's room for improvement in self-development.",
    "userId": 1,
    "createdAt": "2026-01-01T10:00:00.000Z",
    "updatedAt": "2026-01-01T10:00:00.000Z",
    "recommendations": [
      {
        "id": 1,
        "priority": "High",
        "title": "Allocate time for learning",
        "description": "Set aside 30 minutes daily for skill development or learning new technologies relevant to your field.",
        "checked": false,
        "userProgressId": 1
      },
      {
        "id": 2,
        "priority": "Medium",
        "title": "Improve social connections",
        "description": "Schedule weekly catch-ups with friends or join a community group to strengthen social bonds.",
        "checked": false,
        "userProgressId": 1
      }
    ],
    "dimensionalScores": [
      {
        "id": 1,
        "dimension": "Akademik/Pekerjaan & Profesionalisme",
        "score": 80,
        "analysis": "You are performing well in your academic/professional responsibilities with good time management.",
        "userProgressId": 1
      },
      {
        "id": 2,
        "dimension": "Pengembangan Diri",
        "score": 65,
        "analysis": "There's room for improvement in personal development activities.",
        "userProgressId": 1
      },
      {
        "id": 3,
        "dimension": "Sosial & Relasi",
        "score": 70,
        "analysis": "Your social relationships are healthy, but could benefit from more regular interaction.",
        "userProgressId": 1
      },
      {
        "id": 4,
        "dimension": "Personal & Mental",
        "score": 82,
        "analysis": "You're maintaining good mental health and personal well-being.",
        "userProgressId": 1
      },
      {
        "id": 5,
        "dimension": "Karier & Masa Depan",
        "score": 78,
        "analysis": "You have clear career goals and are working towards them effectively.",
        "userProgressId": 1
      }
    ]
  }
  ```

#### Get Latest WLB

- **GET** `/api/wlb/latest`
- **Auth**: Required
- **Response** (200 OK): Same structure as Get Today's WLB response

#### Get WLB History

- **GET** `/api/wlb/history`
- **Auth**: Required
- **Response** (200 OK):
  ```json
  [
    {
      "id": 2,
      "date": "2026-01-02T10:00:00.000Z",
      "score": 78,
      "summary": "Your work-life balance has improved! Keep up the good work.",
      "userId": 1,
      "createdAt": "2026-01-02T10:00:00.000Z",
      "updatedAt": "2026-01-02T10:00:00.000Z",
      "recommendations": [...],
      "dimensionalScores": [...]
    },
    {
      "id": 1,
      "date": "2026-01-01T10:00:00.000Z",
      "score": 75,
      "summary": "Your work-life balance is good overall.",
      "userId": 1,
      "createdAt": "2026-01-01T10:00:00.000Z",
      "updatedAt": "2026-01-01T10:00:00.000Z",
      "recommendations": [...],
      "dimensionalScores": [...]
    }
  ]
  ```

#### Analyze WLB Answers

- **POST** `/api/wlb/analyze`
- **Auth**: Required
- **Request Body**:
  ```json
  {
    "answers": ["SANGAT_SETUJU", "CUKUP_SETUJU", "NETRAL", "..."],
    "isStudent": true
  }
  ```
- **Response** (200 OK): WLB analysis with complete structure (see Get Today's WLB response)
- **Note**: This endpoint processes questionnaire answers and generates AI-powered WLB analysis

#### Recalculate WLB Scores

- **POST** `/api/wlb/recalculate`
- **Auth**: Required
- **Request Body**:
  ```json
  {
    "progress": {
      "id": 1,
      "date": "2026-01-01T10:00:00.000Z",
      "score": 75,
      "summary": "Current summary",
      "userId": 1,
      "recommendations": [...],
      "dimensionalScores": [...]
    }
  }
  ```
- **Response** (200 OK): Recalculated WLB progress (same structure as Get Today's WLB response)
- **Note**: Recalculates scores based on updated schedules, notes, and activities

#### Update Recommendation Status

- **PATCH** `/api/wlb/recommendation/:recommendationId`
- **Auth**: Required
- **Path Params**: `recommendationId` (number)
- **Request Body**:
  ```json
  {
    "checked": true
  }
  ```
- **Response** (200 OK):
  ```json
  {
    "id": 1,
    "priority": "High",
    "title": "Allocate time for learning",
    "description": "Set aside 30 minutes daily for skill development or learning new technologies relevant to your field.",
    "checked": true,
    "userProgressId": 1
  }
  ```

#### Delete User Progress

- **DELETE** `/api/wlb/progress`
- **Auth**: Required
- **Response** (200 OK):
  ```json
  {
    "message": "User progress deleted successfully"
  }
  ```

---

### AI Chat Endpoints (`/api/chat`)

#### Get User's Chat History

- **GET** `/api/chat`
- **Auth**: Required
- **Response** (200 OK):
  ```json
  [
    {
      "id": 1,
      "message": "How can I improve my work-life balance?",
      "answer": "Great question! Based on your current activities, I'd recommend setting clear boundaries between work and personal time. Try scheduling specific 'no-work' hours and stick to them. Also, make sure to include time for hobbies and social activities in your daily routine.",
      "userId": 1,
      "createdAt": "2026-01-01T14:30:00.000Z",
      "updatedAt": "2026-01-01T14:30:00.000Z"
    },
    {
      "id": 2,
      "message": "What are some stress management techniques?",
      "answer": "There are several effective stress management techniques you can try: 1) Practice mindfulness or meditation for 10-15 minutes daily, 2) Regular exercise - even a 30-minute walk can help, 3) Deep breathing exercises when you feel overwhelmed, 4) Maintain a consistent sleep schedule, and 5) Talk to friends or family about your concerns. Would you like more details on any of these?",
      "userId": 1,
      "createdAt": "2026-01-01T15:00:00.000Z",
      "updatedAt": "2026-01-01T15:00:00.000Z"
    }
  ]
  ```

#### Get Chat Quota

- **GET** `/api/chat/quota`
- **Auth**: Required
- **Response** (200 OK):
  ```json
  {
    "chatQuota": 5
  }
  ```
- **Note**: Returns remaining chat quota for the day (max 8, resets at 00:20 WIB)

#### Send Chat Message

- **POST** `/api/chat`
- **Auth**: Required
- **Request Body**:
  ```json
  {
    "message": "How can I better manage my time between work and personal life?"
  }
  ```
- **Response** (201 Created):
  ```json
  {
    "id": 3,
    "message": "How can I better manage my time between work and personal life?",
    "answer": "Time management is crucial for work-life balance! Here are some practical tips: 1) Use time-blocking techniques - dedicate specific hours to work tasks and personal activities, 2) Prioritize tasks using the Eisenhower Matrix (urgent/important), 3) Learn to say 'no' to non-essential commitments, 4) Use productivity tools like calendars and to-do lists, 5) Schedule breaks and personal time just like you would work meetings. Remember, balance doesn't mean equal time for everything, but rather giving appropriate attention to what matters most in each area of your life. Want to explore any of these strategies in more detail?",
    "userId": 1,
    "createdAt": "2026-01-01T16:00:00.000Z",
    "updatedAt": "2026-01-01T16:00:00.000Z"
  }
  ```
- **Error Response** (429 Too Many Requests):
  ```json
  {
    "error": "Chat quota exceeded. Please try again tomorrow."
  }
  ```
- **Note**:
  - Consumes 1 chat quota per request (max 8 per day)
  - Quota resets daily at 01:00 WIB
  - AI responses are generated by Google Gemini API
  - The AI assistant is trained to provide work-life balance guidance

## Background Jobs (node-cron)

- `00 01 * * *` Asia/Jakarta – Recalculate WLB scores and update latest progress per user.
- `00 01 * * *` Asia/Jakarta – Reset daily chat quota for all users.
